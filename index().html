<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gia Sư AI - Trợ lý học tập thông minh</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts for better typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;700&family=Noto+Sans:wght@400;700&family=Noto+Serif:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    
    <!-- KaTeX for rendering LaTeX math formulas -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" xintegrity="sha384-n8MVd4RsNIU07EWpWGbSbeHum6UiOP6masQDjdAMX59cavYghLXYJMYZGjNodkB7" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" xintegrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" xintegrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>
    
    <!-- Marked.js for rendering Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* Custom styles and font families */
        body {
            font-family: 'Be Vietnam Pro', 'Noto Sans', sans-serif;
            background-color: #f0f4f8;
        }
        h1, h2, h3 {
            font-family: 'Be Vietnam Pro', sans-serif;
            font-weight: 700;
        }
        /* Style for the answer container */
        #answer-container {
            font-family: 'Noto Serif', serif;
            line-height: 1.8;
            color: #334155;
        }
        #answer-container code {
            background-color: #e2e8f0;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }
        #answer-container pre {
            background-color: #f1f5f9;
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
        }
        #answer-container blockquote {
            border-left: 4px solid #93c5fd;
            padding-left: 1rem;
            margin-left: 0;
            font-style: italic;
            color: #64748b;
        }
        /* KaTeX font size adjustment */
        .katex {
            font-size: 1.1em !important;
        }
        /* Custom button styles */
        .btn {
            @apply px-4 py-2 rounded-lg font-semibold text-white transition-all duration-300 flex items-center justify-center gap-2 shadow-md;
        }
        .btn-primary {
            @apply bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:ring-blue-300;
        }
        .btn-secondary {
            @apply bg-gray-500 hover:bg-gray-600 focus:ring-4 focus:ring-gray-300;
        }
        /* Spinner animation */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto max-w-4xl p-4 sm:p-6 md:p-8">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-blue-700">Gia Sư AI</h1>
            <p class="text-lg text-gray-600 mt-2">Trợ lý học tập thông minh cho mọi môn học</p>
        </header>

        <!-- Main Content -->
        <main class="bg-white p-6 rounded-2xl shadow-lg">
            
            <!-- Input Section -->
            <div class="mb-6">
                <label for="question-input" class="block mb-2 text-lg font-medium text-gray-700">Nhập câu hỏi của bạn:</label>
                <textarea id="question-input" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow" placeholder="Ví dụ: Giải phương trình x^2 - 3x + 2 = 0 hoặc dán hình ảnh bài tập vào đây..."></textarea>
            </div>

            <!-- Image Handling Section -->
            <div class="mb-6">
                <div id="image-preview-container" class="hidden w-full max-w-sm mx-auto p-4 border-2 border-dashed border-gray-300 rounded-lg text-center">
                    <img id="image-preview" src="" alt="Xem trước ảnh" class="max-h-60 mx-auto rounded-md mb-2">
                    <button id="remove-image-btn" class="text-sm text-red-500 hover:text-red-700">Xóa ảnh</button>
                </div>
                <input type="file" id="file-input" class="hidden" accept="image/*">
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-col sm:flex-row items-center justify-between gap-4 mb-8">
                <div class="flex items-center gap-3">
                    <button id="upload-btn" class="btn btn-secondary">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                        Tải ảnh lên
                    </button>
                    <button id="camera-btn" class="btn btn-secondary">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
                        Chụp ảnh
                    </button>
                </div>
                <button id="solve-btn" class="btn btn-primary w-full sm:w-auto">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 14 4-4"/><path d="M3.34 19a10 10 0 1 1 17.32 0"/></svg>
                    Hướng dẫn giải
                </button>
            </div>

            <!-- Answer Section -->
            <div id="answer-section" class="mt-6 border-t pt-6 border-gray-200">
                <div id="loading-indicator" class="hidden flex flex-col items-center justify-center text-center text-gray-500">
                    <div class="loader mb-4"></div>
                    <p>Gia Sư AI đang suy nghĩ... Vui lòng chờ trong giây lát.</p>
                </div>
                <div id="error-message" class="hidden p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg"></div>
                <div id="answer-container">
                     <div class="text-center text-gray-400">
                        <p>Câu trả lời chi tiết sẽ xuất hiện ở đây.</p>
                        <p class="text-sm mt-1">Hãy nhập câu hỏi hoặc tải ảnh lên để bắt đầu.</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="text-center mt-8 text-sm text-gray-500">
            <p>&copy; 2024 Gia Sư AI. Được phát triển bởi AI.</p>
        </footer>
    </div>

    <script>
        // DOM Elements
        const questionInput = document.getElementById('question-input');
        const solveBtn = document.getElementById('solve-btn');
        const uploadBtn = document.getElementById('upload-btn');
        const cameraBtn = document.getElementById('camera-btn');
        const fileInput = document.getElementById('file-input');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        const removeImageBtn = document.getElementById('remove-image-btn');
        const loadingIndicator = document.getElementById('loading-indicator');
        const answerContainer = document.getElementById('answer-container');
        const errorMessage = document.getElementById('error-message');

        let imageData = null;

        // --- Image Handling ---

        // Function to handle file selection (upload or camera)
        const handleImageFile = (file) => {
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imageData = e.target.result.split(',')[1]; // Get base64 data
                    imagePreview.src = e.target.result;
                    imagePreviewContainer.classList.remove('hidden');
                    answerContainer.innerHTML = ''; // Clear initial message
                };
                reader.readAsDataURL(file);
            }
        };

        // Trigger file input for upload
        uploadBtn.addEventListener('click', () => {
            fileInput.removeAttribute('capture');
            fileInput.click();
        });

        // Trigger file input for camera
        cameraBtn.addEventListener('click', () => {
            fileInput.setAttribute('capture', 'environment');
            fileInput.click();
        });
        
        // Handle file selection
        fileInput.addEventListener('change', (e) => {
            if (e.target.files && e.target.files[0]) {
                handleImageFile(e.target.files[0]);
            }
        });

        // Handle image pasting
        document.addEventListener('paste', (e) => {
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            for (const item of items) {
                if (item.kind === 'file' && item.type.startsWith('image/')) {
                    const file = item.getAsFile();
                    handleImageFile(file);
                    break; 
                }
            }
        });

        // Remove image
        removeImageBtn.addEventListener('click', () => {
            imageData = null;
            imagePreview.src = '';
            imagePreviewContainer.classList.add('hidden');
            fileInput.value = ''; // Reset file input
        });

        // --- API Call and Solution Handling ---

        solveBtn.addEventListener('click', async () => {
            const userText = questionInput.value.trim();

            if (!userText && !imageData) {
                showError('Vui lòng nhập câu hỏi hoặc tải lên hình ảnh.');
                return;
            }

            // Show loading state
            loadingIndicator.classList.remove('hidden');
            answerContainer.innerHTML = '';
            errorMessage.classList.add('hidden');
            solveBtn.disabled = true;
            solveBtn.classList.add('opacity-50', 'cursor-not-allowed');

            try {
                // Construct the prompt for the AI model
                const prompt = `Bạn là một gia sư AI chuyên nghiệp, có thể giải đáp các câu hỏi thuộc mọi môn học từ lớp 1 đến lớp 12 và cả đại học.
Nhiệm vụ của bạn là:
1. Phân tích câu hỏi từ văn bản và/hoặc hình ảnh được cung cấp.
2. **Tự động xác định môn học và lớp học** của câu hỏi một cách chính xác nhất có thể.
3. Trình bày lời giải một cách chi tiết, từng bước, dễ hiểu, khoa học và trực quan.
4. Sử dụng định dạng Markdown để trình bày câu trả lời. Đặc biệt, **sử dụng cú pháp LaTeX được bao bọc bởi $$ cho tất cả các công thức toán học, hóa học, vật lý** (ví dụ: $$x^2 + y^2 = z^2$$).
5. Bắt đầu câu trả lời bằng việc nêu rõ môn học và lớp học bạn đã xác định. Ví dụ: "**Môn:** Toán - **Lớp:** 9". Nếu không chắc chắn, hãy ghi "Không xác định".
6. Giữ giọng văn thân thiện, khuyến khích như một người gia sư thực thụ.

Dưới đây là câu hỏi của người dùng:
Văn bản: "${userText}"`;

                const parts = [{ text: prompt }];
                if (imageData) {
                    parts.push({
                        inlineData: {
                            mimeType: 'image/png',
                            data: imageData
                        }
                    });
                }

                const payload = {
                    contents: [{ role: "user", parts: parts }]
                };
                
                const apiKey = "AIzaSyACWW1mR0t1epof6pnZPwTFERAS2XKiSCA"; // API key will be provided by the environment
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'Có lỗi xảy ra từ phía máy chủ.');
                }

                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0) {
                    const aiResponseText = result.candidates[0].content.parts[0].text;
                    // Use marked to convert Markdown to HTML
                    const htmlContent = marked.parse(aiResponseText);
                    answerContainer.innerHTML = htmlContent;
                    
                    // Use KaTeX to render math formulas within the new content
                    renderMathInElement(answerContainer, {
                        delimiters: [
                            {left: '$$', right: '$$', display: true},
                            {left: '$', right: '$', display: false},
                            {left: '\\(', right: '\\)', display: false},
                            {left: '\\[', right: '\\]', display: true}
                        ],
                        throwOnError: false
                    });

                } else {
                    showError('Không nhận được phản hồi hợp lệ từ AI. Vui lòng thử lại.');
                }

            } catch (error) {
                console.error('Error:', error);
                showError(`Đã có lỗi xảy ra: ${error.message}`);
            } finally {
                // Hide loading state and re-enable button
                loadingIndicator.classList.add('hidden');
                solveBtn.disabled = false;
                solveBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        });

        // Function to display error messages
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
            answerContainer.innerHTML = ''; // Clear any previous answers
        }

    </script>
</body>
</html>
